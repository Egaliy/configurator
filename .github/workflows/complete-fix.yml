name: Complete Fix and Deploy

on:
  workflow_dispatch:

jobs:
  fix-and-deploy:
    runs-on: ubuntu-latest
    timeout-minutes: 60
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install sshpass
        run: sudo apt-get update && sudo apt-get install -y sshpass

      - name: Fix SSH, install dependencies, build and deploy
        env:
          VPS_HOST: ${{ secrets.VPS_HOST }}
          VPS_USER: ${{ secrets.VPS_USER }}
          VPS_PASSWORD: ${{ secrets.VPS_PASSWORD }}
          SSHPASS: ${{ secrets.VPS_PASSWORD }}
        run: |
          export SSHPASS
          SSH_OPTS="-o StrictHostKeyChecking=no -o ConnectTimeout=30 -o ServerAliveInterval=20 -o ServerAliveCountMax=120"
          
          echo "=== 1. Запуск SSH и nginx ==="
          sshpass -e ssh $SSH_OPTS "$VPS_USER@$VPS_HOST" \
            "systemctl start ssh 2>/dev/null || systemctl start sshd 2>/dev/null || true; \
             systemctl enable ssh 2>/dev/null || systemctl enable sshd 2>/dev/null || true; \
             systemctl start nginx" || true
          
          echo "=== 2. Установка зависимостей (может занять 5-10 минут) ==="
          sshpass -e ssh $SSH_OPTS "$VPS_USER@$VPS_HOST" \
            "cd /var/www/like-that && npm ci" || {
            echo "::error::npm ci failed"
            exit 1
          }
          
          echo "=== 3. Prisma generate ==="
          sshpass -e ssh $SSH_OPTS "$VPS_USER@$VPS_HOST" \
            "cd /var/www/like-that && npx prisma generate" || {
            echo "::warning::prisma generate failed, continuing..."
          }
          
          echo "=== 4. Сборка приложения ==="
          sshpass -e ssh $SSH_OPTS "$VPS_USER@$VPS_HOST" \
            "cd /var/www/like-that && npm run build" || {
            echo "::error::build failed"
            exit 1
          }
          
          echo "=== 5. Запуск через PM2 ==="
          sshpass -e ssh $SSH_OPTS "$VPS_USER@$VPS_HOST" \
            "cd /var/www/like-that && pm2 restart like-that 2>/dev/null || pm2 start npm --name like-that -- start; pm2 save" || {
            echo "::error::pm2 start failed"
            exit 1
          }
          
          echo "=== 6. Проверка статуса ==="
          sshpass -e ssh $SSH_OPTS "$VPS_USER@$VPS_HOST" \
            "pm2 list; echo ''; curl -s http://127.0.0.1:3000/api/admin/health 2>/dev/null | head -10 || echo 'App not responding yet'"
          
          echo "✅ Готово! Проверьте http://app.ubernatural.io"
