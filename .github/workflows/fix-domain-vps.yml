# Ручной запуск: залить Like That на VPS, перезагрузить nginx, собрать и запустить приложение.
# Actions → Fix domain on VPS → Run workflow
# Секреты: VPS_HOST, VPS_USER, VPS_PASSWORD — в Repository secrets или в environment (например production)
name: Fix domain on VPS

on:
  workflow_dispatch:

jobs:
  fix:
    runs-on: ubuntu-latest
    timeout-minutes: 20
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install sshpass
        run: sudo apt-get update && sudo apt-get install -y sshpass rsync

      - name: Upload Like That to VPS
        env:
          VPS_HOST: ${{ secrets.VPS_HOST }}
          VPS_USER: ${{ secrets.VPS_USER }}
          VPS_PASSWORD: ${{ secrets.VPS_PASSWORD }}
        run: |
          if [ -z "$VPS_PASSWORD" ] || [ -z "$VPS_HOST" ]; then
            echo "VPS_HOST and VPS_PASSWORD secrets are required."
            exit 1
          fi
          export SSHPASS="$VPS_PASSWORD"
          SSH_OPTS="-o StrictHostKeyChecking=no -o ConnectTimeout=30 -o ServerAliveInterval=15 -o ServerAliveCountMax=20"
          for i in 1 2 3; do
            echo "Upload attempt $i/3..."
            if rsync -avz --delete \
              -e "sshpass -e ssh $SSH_OPTS" \
              --exclude 'node_modules' \
              --exclude '.next' \
              --exclude '.git' \
              "like that/" "$VPS_USER@$VPS_HOST:/var/www/like-that/"; then
              echo "Upload OK."
              exit 0
            fi
            [ $i -lt 3 ] && echo "Retrying in 15s..." && sleep 15
          done
          exit 1

      - name: Reload nginx and build Like That on server
        env:
          VPS_HOST: ${{ secrets.VPS_HOST }}
          VPS_USER: ${{ secrets.VPS_USER }}
          VPS_PASSWORD: ${{ secrets.VPS_PASSWORD }}
          SSHPASS: ${{ secrets.VPS_PASSWORD }}
        run: |
          export SSHPASS
          SSH_OPTS="-o StrictHostKeyChecking=no -o ConnectTimeout=30 -o ServerAliveInterval=15 -o ServerAliveCountMax=120"
          for i in 1 2 3; do
            echo "SSH attempt $i/3..."
            if sshpass -e ssh $SSH_OPTS "$VPS_USER@$VPS_HOST" \
              "systemctl reload nginx; cd /var/www/like-that && bash scripts/build-and-restart.sh"; then
              echo "Done."
              exit 0
            fi
            [ $i -lt 3 ] && echo "Retrying in 20s..." && sleep 20
          done
          exit 1

      - name: Enable HTTPS (Let's Encrypt, optional)
        if: ${{ secrets.SSL_EMAIL != '' }}
        env:
          VPS_HOST: ${{ secrets.VPS_HOST }}
          VPS_USER: ${{ secrets.VPS_USER }}
          VPS_PASSWORD: ${{ secrets.VPS_PASSWORD }}
          SSHPASS: ${{ secrets.VPS_PASSWORD }}
          SSL_EMAIL: ${{ secrets.SSL_EMAIL }}
        run: |
          export SSHPASS
          sshpass -e ssh -o StrictHostKeyChecking=no -o ConnectTimeout=30 "$VPS_USER@$VPS_HOST" \
            "apt-get update -qq && apt-get install -y -qq certbot python3-certbot-nginx >/dev/null 2>&1; certbot --nginx -d app.ubernatural.io --non-interactive --agree-tos -m '$SSL_EMAIL' --redirect 2>/dev/null || true"
