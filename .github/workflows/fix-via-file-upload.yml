name: Fix SSH via File Upload

on:
  workflow_dispatch:

jobs:
  fix:
    runs-on: ubuntu-latest
    timeout-minutes: 15
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install sshpass
        run: sudo apt-get update && sudo apt-get install -y sshpass curl

      - name: Try SSH with multiple methods and retries
        env:
          VPS_HOST: ${{ secrets.VPS_HOST }}
          VPS_USER: ${{ secrets.VPS_USER }}
          VPS_PASSWORD: ${{ secrets.VPS_PASSWORD }}
          SSHPASS: ${{ secrets.VPS_PASSWORD }}
        run: |
          export SSHPASS
          SSH_OPTS="-o StrictHostKeyChecking=no -o ConnectTimeout=15 -o ServerAliveInterval=10 -o ServerAliveCountMax=30"
          FIX_CMD="systemctl start sshd && systemctl enable sshd && systemctl start nginx && cd /var/www/like-that 2>/dev/null && (pm2 restart like-that 2>/dev/null || pm2 start npm --name like-that -- start) && pm2 save && echo 'Done'"
          
          echo "=== Попытка 1: Прямой SSH (с повторами) ==="
          for i in 1 2 3 4 5; do
            echo "Попытка $i/5..."
            if sshpass -e ssh $SSH_OPTS "$VPS_USER@$VPS_HOST" "$FIX_CMD" 2>&1; then
              echo "✅ SSH работает! Команда выполнена."
              exit 0
            fi
            [ $i -lt 5 ] && echo "Ждём 10 секунд..." && sleep 10
          done
          
          echo "=== Попытка 2: SSH с увеличенным таймаутом ==="
          SSH_OPTS_LONG="-o StrictHostKeyChecking=no -o ConnectTimeout=30 -o ServerAliveInterval=20 -o ServerAliveCountMax=60"
          for i in 1 2 3; do
            echo "Попытка $i/3 с длинным таймаутом..."
            if timeout 60 sshpass -e ssh $SSH_OPTS_LONG "$VPS_USER@$VPS_HOST" "$FIX_CMD" 2>&1; then
              echo "✅ SSH работает с длинным таймаутом!"
              exit 0
            fi
            [ $i -lt 3 ] && echo "Ждём 15 секунд..." && sleep 15
          done
          
          echo "=== Попытка 3: Проверка доступности порта 22 ==="
          if nc -zv -w 5 "$VPS_HOST" 22 2>&1 | grep -q "succeeded"; then
            echo "Порт 22 открыт, но SSH не отвечает. Возможно проблема с аутентификацией."
          else
            echo "Порт 22 закрыт или недоступен."
          fi
          
          echo "❌ SSH недоступен. Попробуйте:"
          echo "1. Через панель провайдера VPS (веб-консоль)"
          echo "2. Связаться с поддержкой провайдера"
          echo "3. Проверить firewall на VPS"
          exit 1
