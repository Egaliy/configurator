name: Cleanup Server - Remove Application

on:
  workflow_dispatch:
    inputs:
      confirm:
        description: 'Type "DELETE" to confirm removal'
        required: true
        default: ''

jobs:
  cleanup:
    runs-on: ubuntu-latest
    if: github.event.inputs.confirm == 'DELETE'
    
    steps:
      - name: Remove application from server
        uses: appleboy/ssh-action@master
        with:
          host: ${{ secrets.VPS_HOST }}
          username: ${{ secrets.VPS_USER }}
          key: ${{ secrets.VPS_SSH_KEY }}
          timeout: 60s
          command_timeout: 5m
          script: |
            set -e
            echo "üóëÔ∏è –£–¥–∞–ª–µ–Ω–∏–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è —Å —Å–µ—Ä–≤–µ—Ä–∞..."
            
            # –û—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –∏ —É–¥–∞–ª–∏—Ç—å PM2 –ø—Ä–æ—Ü–µ—Å—Å
            echo "–û—Å—Ç–∞–Ω–æ–≤–∫–∞ PM2 –ø—Ä–æ—Ü–µ—Å—Å–∞..."
            pm2 delete look-like 2>/dev/null || pm2 stop look-like 2>/dev/null || echo "PM2 –ø—Ä–æ—Ü–µ—Å—Å –Ω–µ –Ω–∞–π–¥–µ–Ω"
            pm2 save 2>/dev/null || true
            
            # –£–¥–∞–ª–∏—Ç—å –ø–∞–ø–∫–∏ –ø—Ä–æ–µ–∫—Ç–∞ (–ø—Ä–æ–≤–µ—Ä—è–µ–º –æ–±–∞ –≤–æ–∑–º–æ–∂–Ω—ã—Ö –Ω–∞–∑–≤–∞–Ω–∏—è)
            PROJECT_PATHS=(
              "${{ secrets.VPS_PROJECT_PATH || '/var/www/look-like' }}"
              "/var/www/look-like"
              "/var/www/like-that"
              "/var/www/like-that"
            )
            
            for path in "${PROJECT_PATHS[@]}"; do
              if [ -d "$path" ]; then
                echo "–£–¥–∞–ª–µ–Ω–∏–µ –ø–∞–ø–∫–∏: $path"
                rm -rf "$path"
                echo "‚úÖ –£–¥–∞–ª–µ–Ω–æ: $path"
              fi
            done
            
            # –£–¥–∞–ª–∏—Ç—å PM2 –∫–æ–Ω—Ñ–∏–≥ –µ—Å–ª–∏ –µ—Å—Ç—å
            if [ -f ~/.pm2/dump.pm2 ]; then
              pm2 kill 2>/dev/null || true
              rm -f ~/.pm2/dump.pm2 2>/dev/null || true
            fi
            
            echo "‚úÖ –û—á–∏—Å—Ç–∫–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–∞. –ü—Ä–∏–ª–æ–∂–µ–Ω–∏–µ —É–¥–∞–ª–µ–Ω–æ —Å —Å–µ—Ä–≤–µ—Ä–∞."
